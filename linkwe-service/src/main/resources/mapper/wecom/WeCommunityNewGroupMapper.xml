<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linkwechat.mapper.WeCommunityNewGroupMapper">



    <select id="countTab" resultType="com.linkwechat.domain.community.vo.WeCommunityNewGroupTabCountVo">
        SELECT
            (
                SELECT
                    count(*)
                FROM
                    we_customer where state=#{newGroup.emplCodeState}
            ) as addCustomerNumber,
            (
                SELECT
                    count(*)
                FROM
                    we_customer where date_format(add_time,'%Y-%m-%d') = date_format(curdate(),'%Y-%m-%d') and state=#{newGroup.emplCodeState}
            ) as tdAddCustomerNumber,
            (
                SELECT
                    count(*)
                FROM we_group_member where state=#{newGroup.groupCodeState}
            ) as joinGroupCustomerNumber,
            (
                SELECT
                    count(*)
                FROM we_group_member WHERE date_format(join_time,'%Y-%m-%d') = date_format(curdate(),'%Y-%m-%d') and state=#{newGroup.groupCodeState}
            ) as tdJoinGroupCustomerNumber
    </select>


    <select id="findTrendCountVo" resultType="com.linkwechat.domain.community.vo.WeCommunityNewGroupTrendCountVo">
        SELECT
            sdd.date,
            (
                SELECT
                    count(*)
                FROM
                    we_customer wc
                WHERE
                        DATE_FORMAT( wc.add_time, '%Y-%m-%d' )= DATE_FORMAT( sdd.date, '%Y-%m-%d' )
                  AND wc.state = #{newGroup.emplCodeState}
            ) AS addCustomerNumber,
            (
                SELECT
                    count(*)
                FROM
                    we_group_member wgm
                WHERE
                        DATE_FORMAT( wgm.join_time, '%Y-%m-%d' )= DATE_FORMAT( sdd.date, '%Y-%m-%d' )
                  AND wgm.state = #{newGroup.groupCodeState}
            ) AS joinGroupCustomerNumber
        FROM
            sys_dim_date sdd
        WHERE
            DATE_FORMAT( sdd.date, '%Y-%m-%d' ) BETWEEN #{newGroup.beginTime} AND #{newGroup.endTime}
    </select>



    <select id="findWeCommunityNewGroupTable" resultType="com.linkwechat.domain.community.vo.WeCommunityNewGroupTableVo">
        SELECT
            wc.avatar,
            wc.customer_name,
            wc.customer_type,
            wc.external_userid as externalUserid,
            wc.add_user_id,
            wc.add_time,
            wc.gender,
            IF(ISNULL(wgm.chat_id),0,1) as isJoinGroup,
            wgm.chat_id,
            wgm.join_time,
            (SELECT GROUP_CONCAT(wg.group_name) from we_group wg where wg.chat_id=wgm.chat_id) as groupName
        FROM
            we_customer wc
                LEFT JOIN we_group_member wgm ON wc.external_userid=wgm.user_id
        <where>
           <if test="query.state != null and query.state !=''">
                and wc.state = #{query.state}
           </if>
           <if test="query.customerName != null and query.customerName !='' ">
             and  wc.customer_name  LIKE CONCAT('%',#{query.customerName,jdbcType=VARCHAR},'%')
           </if>

          <if test="query.startAddTime != null and query.startAddTime !='' and query.endAddTime != null and query.endAddTime !='' ">
              AND  date_format(wcr.add_time,'%Y-%m-%d') BETWEEN #{query.startAddTime} AND #{query.endAddTime}
          </if>
          <if test="query.chatId !=null and query.chatId !=''">
              AND wgm.chat_id != #{query.chatId}
          </if>
          <if test="query.startJoinTime != null and query.startJoinTime !='' and query.endJoinTime != null and query.endJoinTime !='' ">
             AND  date_format(wgm.join_time,'%Y-%m-%d') BETWEEN #{query.startJoinTime} AND #{query.endJoinTime}
          </if>
          <choose>
              <when test="query.isJoinGroup != null">
                <if test="query.isJoinGroup ==1 ">
                    and wgm.chat_id IS NOT NULL
                </if>
                <if test="query.isJoinGroup ==0">
                    and wgm.chat_id IS NULL
                </if>
              </when>
          </choose>

        </where>
    </select>


</mapper>